<!doctype html>
<html>
    <head>
        <title>Quadtrees</title>
        <meta charset="utf-8" />
    </head>
    <body style="margin: 0px; overflow: hidden; background-color: #fff">
        <canvas id="c"></canvas>
        <script>
            var a = document.getElementsByTagName('canvas')[0];
            var b = document.body;
            var d = function(e) { return function() { e.parentNode.removeChild(e) } }(a);

            // unprefix some popular vendor prefixed things (but stick to their original name)
            var AudioContext = window.AudioContext
                || window.webkitAudioContext;
            var requestAnimationFrame = window.requestAnimationFrame
                || window.mozRequestAnimationFrame
                || window.webkitRequestAnimationFrame
                || window.msRequestAnimationFrame
                || function(f) { setTimeout(f, 1000/30) };

            // stretch canvas to screen size (once, wont onresize!)
            a.style.width = (a.width = innerWidth) + 'px';
            a.style.height = (a.height = innerHeight) + 'px';
            var c = a.getContext('2d');
        </script>
        <script>
            A = 0;              // angle of view
            B = 0;              // change indicator
            D = 1200;           // distance to center
            H = 150;            // height above level 0
            X = a.width/2;      // vanishing point coordinates
            Y = a.height/1.5;
            T = 0;
            V = [];             // vertices: I = i(i+1)/2+j,
            R = 2;
            N = 2<<R;
            F = [[0, 0, N*(N+1)/2, N*(N+3)/2]]; // faces [depth, vertex index 1, vertex index 2, vertex index 3]
            V[0] = [0, 0, 0];
            V[N*(N+1)/2] = [N, 0, 0];
            V[N*(N+3)/2] = [N, N, 0];

            for (i=0; f=F[i++]; ) {
                //console.log(V);
                //console.log(F);

                if (f[0] < R) {
                    r = f[0]+1;
                    n = N>>r;

                    // get triangle vertices
                    v0 = V[f[1]]; z0 = v0[2];
                    v1 = V[f[2]]; z1 = v1[2];
                    v2 = V[f[3]]; z2 = v2[2];

                    // compute 3 new vertices
                    i0 = (f[1]+f[2]-n)/2;
                    V[i0] = V[i0] || [v0[0]+n, v0[1], 0/*(z0+z1)/2+600*(Math.random()-0.5)/r/r*/];
                    i1 = i0+n;
                    V[i1] = V[i1] || [v0[0]+n+n, v0[1]+n, 0/*(z1+z2)/2+600*(Math.random()-0.5)/r/r*/];
                    i2 = f[3]+n;
                    V[i2] = V[i2] || [v0[0]+n, v0[1]+n, 0/*(z2+z0)/2+600*(Math.random()-0.5)/r/r*/];

                    // create 4 new faces
                    F.push([r, i0, i1, i2]);
                    F.push([r, f[1], i0, i2]);
                    F.push([r, f[2], i1, i0]);
                    F.push([r, f[3], i2, i1]);
                }
            }

            // rendering procedure ----------------------------------------
            setInterval(function(e) {

                if (B || !T) {
                    // pre-compute useful values
                    m = Math.cos(A);
                    n = Math.sin(A);
                    i = m*D;
                    j = n*D;
                    E = H/2;

                    // draw canvas background
                    a.width = a.width; // cross-browser trick to reset canvas
                    L = 100;
                    c.strokeStyle = 'rgb('+L+','+L+','+L+')';

                    for (i=0; f=F[i++]; ) {
                        if (f[0] == R) {
                            //console.log(f);
                            c.beginPath();
                            for (j=1; v=V[f[j++]]; ) {
                                //console.log(v)
                                x = 20*v[1]-10*v[0];
                                y = 20*v[0];
                                z = v[2];
                                d = D-(m*x+n*y);
                                g = m*y-n*x;
                                s = X/d; // perspective factor = width/(d*tan(angle of view frustrum))
                                t = [X+s*g, Y+s*H-s*z-E];
                                j ? c.lineTo(t[0], t[1]) : c.moveTo(t[0], t[1]);
                            }
                            c.closePath();
                            c.stroke();
                            //c.fill();
                        }
                    }
                }
                T++;

            }, 0)

            onkeydown = function(e) {
                B = 1; // change indicator
                H += 8*(e.which == 33) - 8*(e.which == 34)*(H > 20); // height
                A += .01*(e.which == 39) - .01*(e.which == 37); // angle
                D += 8*(e.which == 40) - 8*(e.which == 38) // distance
                e.preventDefault(); // to make iframe integration easier, not part of the actual js1k entry
            }

            onkeyup = function(e) {
                B = 0 // change indicator
            }
        </script>
    </body>
</html>
