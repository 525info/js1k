<!doctype html>
<html>
    <head>
        <title>Raycaster</title>
        <meta charset="utf-8" />
        <style>
            #fps {
                position: absolute;
                top: 0;
            }
        </style>
    </head>
    <body style="margin: 0px; overflow: hidden; background-color: #fff">
        <canvas></canvas>
        <div id="fps"></div>
        <script>
            var a = document.getElementsByTagName('canvas')[0];
            var b = document.body;
            var d = function(e) { return function() { e.parentNode.removeChild(e) } }(a);

            // unprefix some popular vendor prefixed things (but stick to their original name)
            var AudioContext = window.AudioContext
                || window.webkitAudioContext;
            var requestAnimationFrame = window.requestAnimationFrame
                || window.mozRequestAnimationFrame
                || window.webkitRequestAnimationFrame
                || window.msRequestAnimationFrame
                || function(f) { setTimeout(f, 1000/30) };

            // stretch canvas to screen size (once, wont onresize!)
            a.style.width = (a.width = innerWidth) + 'px';
            a.style.height = (a.height = innerHeight) + 'px';
            var c = a.getContext('2d');
        </script>
        <script>
            // Improvements:
            // * multiple key pressed
            // * merge consecutive rects with same color
            // * heading up and down
            // * biomes
            // * distance fog

            var fps = (function(id) {
                    var fpsd = document.getElementById(id),
                        fpsl = 10,
                        fpss = new Array(fpsl),
                        fpsi = 0,
                        sum = 0,
                        oldtime = +new Date;
                    return function(time) {
                        fpsd.innerHTML = 0|(sum += -(fpss[fpsi%fpsl] || 0) + (fpss[fpsi++%fpsl] = 1000/(-oldtime+(oldtime = time))))/fpsl; // nb. frames/s (sliding window)
                    };
                })('fps');

            W = a.width;
            H = a.height;
            K = H/2;
            A = Math.PI/4;
            S = 0|W/150;
            Z = 100;
            N = 1<<10; // 1024
            X = Y = 0;
            C = 16;
            V = .7;
            AAA = 0;
            AA = 0;
            ZZ = 0;
            HH = 0;
            halt = false;

            onkeydown = onkeyup = function(e) {
                AAA = 5E-5*((e.which == 37) - (e.which == 39))*!!e.type[5]; // angle
                ZZ = ((e.which == 38) - (e.which == 40))*!!e.type[5]; // height
                HH += 5*((e.which == 33) - (e.which == 34)); // height
                e.which == 32 && e.type[5] && (halt = !halt);
                //VV = ((e.which == 38) - (e.which == 40))*!!e.type[5];
                //e.preventDefault(); // to make iframe integration easier, not part of the actual js1k entry
            };

            // rendering procedure ----------------------------------------
            (function render(time) {

                if (!halt) {
                    A += AA += AAA;
                    X += V*Math.cos(A);
                    Y += V*Math.sin(A);
                    Z += ZZ*.5;

                    a.width = a.width;
                    R = [[],[],[],[]];
                    for (k=0; k < W; k += S) {
                        angle = A+Math.atan(0.5-k/W);
                        /*hm = 50*Math.cos(angle*10);
                        c.fillStyle = '#555';
                        c.fillRect(k, H/2-50-hm, S, H/2+50+hm);*/

                        cos = Math.cos(angle);
                        cp = cos > 0;
                        sin = Math.sin(angle);
                        sp = sin > 0;
                        Di = C/Math.abs(cos);
                        Dj = C/Math.abs(sin);
                        x = X;
                        y = Y;
                        i = 0|x/C;
                        j = 0|y/C;
                        di = (cp ? C-X%C : X%C)*Di/C;
                        dj = (sp ? C-Y%C : Y%C)*Dj/C;

                        hh = H;
                        dd = 0;

                        for (s=0; x >= 0 && x < N && y >= 0 && y < N; s++) {
                            if (di < dj) {
                                dd += di;
                                x = C*(cp ? ++i : i--);
                                y += di*sin;
                                dj -= di;
                                di = Di
                            } else {
                                dd += dj;
                                y = C*(sp ? ++j : j--);
                                x += dj*cos;
                                di -= dj;
                                dj = Dj;
                            }
                            z = 50+50*(Math.cos(x/50)*Math.cos(y/50)); // height = f(i, j, x, y)
                            color = z > 50 ? 0|z/30 : (i^j)&1; //0|z/30;// | dd > 300;
                            h = K+K*(Z-z)/dd/*-U*(0.5-k/W)*5000*/;
                            //h -= h%2;
                            h < hh
                              ? R[color].push(hh-h, k, hh = h+1)
                              : R[2].push(2, k, hh); // ridge line
                        }
                    }
                    // group fillrects by color context
                    for (k=0; k<3; k++) {
                        f = 2*k;
                        c.fillStyle = '#'+f+f+f;
                        for (j=0, r = R[k] || []; h=R[k][j++]; ) {
                            c.fillRect(R[k][j++], R[k][j++], S, h);
                        }
                    }
                    fps(time);
                }

                requestAnimationFrame(render);
            })(0);
        </script>
    </body>
</html>
